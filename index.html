<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="p5.min.js"></script>
    <script src="ccapture.all.min.js"></script>
    <script src="keycontrol.js"></script>
    <title>Generative Art</title>
  </head>
  <body>
    <div id="links"></div>
    <script>

      let recording = false
      let file = 0
      let seed = Date.now()
      seed = 1584589142348
      
      let rows = 16
      let cols = 16
      let t = 1

      v.add('rate', .08, -3)
      v.add('particles', 20)
      v.add('force', 1)
      v.add('radius', 40)

      let parts = []
      let colWidth, rowHeight

      let imgs = []
      let diameter = 60

      function preload() {
        imgs.push(loadImage('assets/troll.png'))
        imgs.push(loadImage('assets/tongue.png'))
        imgs.push(loadImage('assets/ooo.png'))
      }

      function setup() {
        randomSeed(seed)
        noiseSeed(seed)

        createCanvas(500, 500)
        background(255)

        colWidth = width / cols
        rowHeight = height / rows

        for (let i = 0; i < 1000; i++) {
          let x = random(width)+width
          let y = random(height)
          parts.push(createVector(x, y))
          parts[i].radius = random(4, diameter) //diameter // random(diameter)
          parts[i].alpha  = random(60, 200)
          parts[i].face = imgs[floor(random(imgs.length))]
          diameter -= 2
        }

      }

      function draw() {
        v.input()

        t += v.rate
        for (let i = 0; i < v.particles; i++) {
          const part = parts[i]
          if (part.dead) continue
          const col = floor(part.x / width * cols)
          const row = floor(part.y / height * rows)
          const angle = map(noise((col << 8) | row, i*2, t), 0, 1, 0, 2 * PI)
          const vec = p5.Vector.fromAngle(angle)
          vec.mult(v.force)
          part.add(vec)

          // if (part.x < 0) {
          //   if (random() < .75) part.dead = true
          //   else part.x += width
          // }
          // else if (part.x > width) part.x -= width
          // if (part.y < 0) part.y += height
          // else if (part.y > height) part.y -= height
          stroke(0,0,0,part.alpha)
          // part.radius -= .05
          if (part.radius <= 0) part.dead = true
          circle(part.x, part.y, part.radius)
          image(
            part.face,
            part.x - part.radius / 2 + 2,
            part.y - part.radius / 2 + 2,
            part.radius - 2,
            part.radius - 2,
          )
        }

        let filename = file.toString()
        while (filename.length < 4) filename = '0' + filename
        if (recording) saveCanvas(filename, 'png')
        file++
        setTimeout(() => loop(), 100)
        noLoop()
      }

      function keyPressed() {
        if (key === 's') {
          // saveCanvas(`${seed}`, 'png')
          recording = false
        }
      }
    </script>
  </body>
</html>
